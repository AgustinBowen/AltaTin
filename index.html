<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUDitin</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<style>
    body{
        background: url(./images.png);
        color: #ffff;
        display: flex;
        flex-direction: column;
        gap: 20px;
        justify-content: center;
        align-items: center;
    }
    h1{
        color: #00ff37;
    }
    p{
        color: #ff00bf;
    }
    input{
        background-color: #464646;
        color: #fff;
        height: 20px;
        padding: 10px;
        width: auto;
    }
    button{
        background-color: #3a0069;
        color: #fff;
        height: 45px;
        padding: 10px;
        width: auto;
    }
    .error {
        color: red;
        font-size: 12px;
        margin-top: -10px;
        margin-bottom: 10px;
        display: block;
    }
    button:hover{
        cursor: pointer;
    }
    input::placeholder{
        color: #afafaf;
    }
    table{
        background-color: #000613;
        border: 6px double #464646;
        padding: 15px;
    }
    table > tbody > tr > td{
        padding: 10px;
        border: 1px solid #fff;
    }
    .contenedor-tabla{
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .acciones{
        display: flex;
        gap: 15px;
    }
    header{
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .wrapperMain{
        display: flex;
        justify-content: center;
        gap: 100px;
        margin-bottom: 50px;
    }
    #formAgregarCliente{
        background-color: #000613;
        padding: 20px;
        border: 6px ridge #464646;
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 300px;
    }
    .contenedorFormulario{
        display: none;
    }
    .active{
        display: block;
    }
</style>
<body>
    <header>
        <h1>CRUDitin</h1>
        <p>El mejor CRUD del universo</p>
        <nav class="acciones">
            <input type="text" placeholder="Nombre,Apellido,Dni" id="buscador">
            <button type="button" id="btnAbrirFormulario">Agregar Cliente</button>
        </nav>
    </header>
    <main class="wrapperMain">
        <section class="contenedor-tabla">
            <h2>Clientes</h2>
            <table>
                <thead>
                    <td>DNI</td>
                    <td>Nombre</td>
                    <td>Apellido</td>
                    <td>Email</td>
                    <td>Telefono</td>
                </thead>
                <tbody>
                </tbody>
            </table>
        </section>
        <section class="contenedorFormulario">
            <form method="POST" action="/clientes" id="formAgregarCliente">
                <div class="formHeader" style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>Agregar Cliente</h1>
                    <button type="button" style="width: 40px;" id="btnCerrarForm">X</button>
                </div>
                <input type="number" name="DNI" id="DNI" placeholder="DNI">
                <span class="error" id="errorDNI"></span>

                <input type="text" name="nombre" id="nombre" placeholder="Nombre">
                <span class="error" id="errorNombre"></span>

                <input type="text" name="apellido" id="apellido" placeholder="Apellido">
                <span class="error" id="errorApellido"></span>

                <input type="email" name="email" id="email" placeholder="verstappen@gmail.com">
                <span class="error" id="errorEmail"></span>

                <input type="text" name="telefono" id="telefono" placeholder="2804929292">
                <span class="error" id="errorTelefono"></span>
                <button type="submit" id="btnAgregar">Agregar</button>
            </form>
        </section>
    </main>
<script type="module">
    const url = "/clientes"
    const btnAbrirFormulario = document.getElementById("btnAbrirFormulario")
    const contenedorFormulario = document.querySelector(".contenedorFormulario")
    const btnCerarrFormulario = document.getElementById("btnCerrarForm")
    const btnAgregar = document.getElementById("btnAgregar")
    const form = document.getElementById("formAgregarCliente")
    let clientes = [];
    btnAbrirFormulario.addEventListener('click',formularioHandler)
    btnCerarrFormulario.addEventListener('click',formularioHandler)
    const buscador = document.getElementById("buscador");

    buscador.addEventListener("input", () => {
        const texto = buscador.value.toLowerCase();

        const filtrados = clientes.filter(c => 
            c.DNI.toString().includes(texto) ||
            c.nombre.toLowerCase().includes(texto) ||
            c.apellido.toLowerCase().includes(texto)
        );

        renderTabla(filtrados);
    });

    function renderTabla(lista) {
        document.querySelector("tbody").innerHTML = lista.map(item => `
            <tr>
                <td>${item.DNI}</td>
                <td>${item.nombre}</td>
                <td>${item.apellido}</td>
                <td>${item.email}</td>
                <td>${item.telefono}</td>
            </tr>
        `).join("");
    }

    try {
        const data = await fetch(url);
        if (!data.ok) {
            throw new Error(`Response status: ${data.status}`);
        }
        clientes = await data.json();
        renderTabla(clientes);
    } catch (error) {
        console.log(error);
    }
    function formularioHandler(){
        if(!contenedorFormulario.classList.contains("active")){
            contenedorFormulario.classList.add("active")
        }else{
            contenedorFormulario.classList.remove("active")
        }
    }

    form.addEventListener('submit', event => {
        event.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        // Expresiones regulares
        const regexNombre = /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/;
        const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const regexTelefono = /^[0-9-]+$/;

        // Reset de errores
        document.querySelectorAll(".error").forEach(el => el.textContent = "");

        let valido = true;

        if (!regexNombre.test(data.nombre)) {
            document.getElementById("errorNombre").textContent = "El nombre solo puede contener letras.";
            valido = false;
        }
        if (!regexNombre.test(data.apellido)) {
            document.getElementById("errorApellido").textContent = "El apellido solo puede contener letras.";
            valido = false;
        }
        if (!regexEmail.test(data.email)) {
            document.getElementById("errorEmail").textContent = "El email no es válido.";
            valido = false;
        }
        if (!regexTelefono.test(data.telefono)) {
            document.getElementById("errorTelefono").textContent = "El teléfono solo puede contener números y '-'.";
            valido = false;
        }

        if (!valido) return; // si hay errores, no mando nada

        // Si todo está bien, mando al backend
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(res => {
            if (!res.ok) {
                return res.json().then(err => { throw err; });
            }
            return res.json();
        }).then(respuesta => {
            clientes.push(data);
            renderTabla(clientes);
            form.reset();
            contenedorFormulario.classList.remove("active");
        }).catch(error => {
            // si el backend devuelve errores, los muestro en los inputs
            if (error.errores) {
                if (error.errores.nombre) document.getElementById("errorNombre").textContent = error.errores.nombre;
                if (error.errores.apellido) document.getElementById("errorApellido").textContent = error.errores.apellido;
                if (error.errores.email) document.getElementById("errorEmail").textContent = error.errores.email;
                if (error.errores.telefono) document.getElementById("errorTelefono").textContent = error.errores.telefono;
            }
        });
    });
</script>
</body>
</html>